<%- include('../partials/user/header') %>
<div><br><br><br><br></div>

<style>
  .disabled-link {
    pointer-events: none;
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>

<!-- breadcrumb -->
<div class="container">
  <div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
    <a href="/" class="stext-109 cl8 hov-cl1 trans-04">
      Home
      <i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
    </a>
    <span class="stext-109 cl4">Shopping Cart</span>
  </div>
</div>

<!-- Shopping Cart -->
<form class="bg0 p-t-75 p-b-85" id="cartForm">
  <div class="container">
    <div class="row">
      <div class="col-lg-10 col-xl-7 m-lr-auto m-b-50">
        <div class="m-l-25 m-r--38 m-lr-0-xl">
          <div class="wrap-table-shopping-cart">
            <table class="table-shopping-cart">
              <tr class="table_head">
                <th class="column-1">Product</th>
                <th class="column-2"></th>
                <th class="column-3">Price</th>
                <th class="column-4">Quantity</th>
                <th class="column-5">Total</th>
                <th class="column-6">Remove</th>
              </tr>

              <% if(cartItems.length === 0) { %>
                <tr><td colspan="6" class="text-center">Your cart is empty.</td></tr>
              <% } else { %>
                <% cartItems.forEach((item, index) => { %>
                  <tr class="table_row">
                    <td class="column-1">
                      <div class="how-itemcart1">
                        <img src="/<%= item.productImage %>" alt="<%= item.productName %>">
                      </div>
                    </td>
                    <td class="column-2">
                      <%= item.productName %> <br>
                      <small>Size: <b><%= item.size %></b> | Color: <b><%= item.color %></b></small><br>
                      <small>Brand: <b><%= item.brandName %></b></small>
                    </td>
                    <td class="column-3">₹ <%= item.productPrice.toFixed(2) %></td>

                    <!-- Quantity controls -->
                    <td class="column-4">
                      <div class="wrap-num-product flex-w m-l-auto m-r-0" data-index="<%= index %>">
                        <button 
                            type="button" 
                            class="btn-num-product-down cl8 hov-btn3 trans-04 flex-c-m" 
                            onclick="changeQuantity('<%= item.productId %>', -1, <%= item.productPrice %>, <%= index %>, <%= item.productStock %>,'<%= item.size %>', '<%= item.color %>')"
                            
                            >
                            -
                            </button>

                            <input 
                            class="mtext-104 cl3 txt-center num-product" 
                            type="number" 
                            name="quantity" 
                            id="cartProductQuantity<%= index %>" 
                            value="<%= item.quantity %>" 
                            min="1" 
                            max="<%= item.productStock %>" 
                            readonly
                            <%= item.productStock <= 0 ? 'disabled' : '' %>
                            >

                            <button 
                            type="button" 
                            class="btn-num-product-up cl8 hov-btn3 trans-04 flex-c-m" 
                            onclick="changeQuantity('<%= item.productId %>', 1, <%= item.productPrice %>, <%= index %>, <%= item.productStock %>,'<%= item.size %>', '<%= item.color %>')"
                           
                            >
                            +
                            </button>

                      </div>
                      <!-- <% if (item.productStock <= 0) { %>
                        <small class="text-danger">Out of Stock</small>
                      <% } %> -->
                      <% if (item.isBlocked) { %>
                        <small class="text-danger">Blocked by Admin</small>
                      <% } else if (!item.isCategoryListed) { %>
                        <small class="text-danger">Category Unlisted</small>
                      <% } else if (item.isOutOfStock) { %>
                        <small class="text-danger">Out of Stock</small>
                      <% } else if (item.exceedsStock) { %>
                        <small class="text-warning">Only <%= item.productStock %> left in stock</small>
                      <% } else if (item.exceedsLimit) { %>
                        <small class="text-warning">Limit is 3 units per item</small>
                      <% } %>
                      
                    </td>

                    <!-- Subtotal with id for JS update -->
                    <td class="column-5" id="subTotal<%= index %>">₹ <%= (item.productPrice * item.quantity).toFixed(2) %></td>

                    <!-- Remove item -->
                 
                      <td class="column-6">
                        <a class="btn btn-sm" href="#" onclick="confirmRemove('<%= item.productId %>', '<%= item.size %>','<%= item.color %>', <%= index %>)">
                          <i class="fi-rs-trash"></i> Remove
                        </a>
                      </td>
                    
                      
                      
                  </tr>
                <% }) %>
              <% } %>
            </table>
          </div>
        </div>
      </div>

      <div class="col-sm-10 col-lg-7 col-xl-5 m-lr-auto m-b-50">
        <div class="bor10 p-lr-40 p-t-30 p-b-40 m-l-63 m-r-40 m-lr-0-xl p-lr-15-sm">
          <h4 class="mtext-109 cl2 p-b-30">Cart Totals</h4>

          <div class="flex-w flex-t bor12 p-b-13">
            <div class="size-208">
              <span class="stext-110 cl2">Subtotal:</span>
            </div>
            <div class="size-209">
              <span class="mtext-110 cl2" id="total">₹ <%= grandTotal.toFixed(2) %></span>
            </div>
          </div>

          <div class="flex-w flex-t bor12 p-t-15 p-b-30">
            <div class="size-208 w-full-ssm">
              <span class="stext-110 cl2">Shipping:</span>
            </div>
            <div class="size-209">
              <span class="mtext-110 cl2" id="shippingCharge">₹ <%= shippingCharge.toFixed(2) %></span>
              <a href="#" onclick="viewShippingCharge()" class="text-blue text-sm">View shipping charge</a>
            </div>
          </div>

          <div class="flex-w flex-t p-t-27 p-b-33">
            <div class="size-208">
              <span class="mtext-101 cl2">Total:</span>
            </div>
            <div class="size-209 p-t-1">
              <span class="mtext-110 cl2" id="totalPayable">₹ <%= totalPayable.toFixed(2) %></span>
            </div>
          </div>
           <a 
            href="javascript:void(0)" 
            id="proceedCheckout"
            class="flex-c-m stext-101 cl0 size-116 bg3 bor14 hov-btn3 p-lr-15 trans-04 pointer"
          >
            Proceed to Checkout
          </a>
         </div>
      </div>
    </div>
  </div>
</form>
<%- include('../partials/user/footer') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Script to show alert if out-of-stock -->

<script>
  document.getElementById('proceedCheckout').addEventListener('click', function(event) {
    event.preventDefault();
  
    fetch('/validate-cart')
      .then(response => response.json())
      .then(data => {
        if (data.valid) {
          window.location.href = '/checkout';
        } else {
          Swal.fire({
            icon: 'warning',
            title: 'Cart Validation Failed',
            text: data.message || 'One or more items are invalid or unavailable.',
            confirmButtonText: 'OK'
          });
        }
      })
      .catch(err => {
        console.error('Validation error:', err);
        Swal.fire({
          icon: 'error',
          title: 'Server Error',
          text: 'Could not validate cart. Please try again later.',
        });
      });
  });
  
</script>
<script>
  function viewShippingCharge() {
    Swal.fire({
      title: 'Shipping Charge',
      text: 'Shipping charge is ₹ 50.00 for all orders below 500.',
      icon: 'info',
      confirmButtonText: 'OK'
    });
  }

 //change quantity
  function changeQuantity(productId, count, productPrice, index, maxStock, size, color) {
    maxStock = parseInt(maxStock);
    const quantityInput = document.getElementById(`cartProductQuantity${index}`);
    const subtotalElement = document.getElementById(`subTotal${index}`);
    const totalElement = document.getElementById('total');
    const shippingChargeElement = document.getElementById('shippingCharge');
    const totalPayableElement = document.getElementById('totalPayable');
    const currentQuantity = parseInt(quantityInput.value);
    const attemptedQuantity = currentQuantity + count;
   //Block decreasing below 1
  if (currentQuantity === 1 && count === -1) {
    Swal.fire({
      icon: 'warning',
      title: 'Oops!',
      text: 'You could not decrease quantity below 1.'
    }).then(() => {
      quantityInput.value = currentQuantity; // restore visual
    });
    return;
  }

  // Block increasing above 3
  if (currentQuantity === 3 && count === 1) {
    Swal.fire({
      icon: 'warning',
      title: 'Oops!',
      text: 'You could not increase quantity. Maximum 3 units allowed.'
    }).then(() => {
      quantityInput.value = currentQuantity; // restore visual
    });
    return;
  }

  // Block if exceeding stock
  if (attemptedQuantity > maxStock) {
    Swal.fire({
      icon: 'warning',
      title: 'Oops!',
      text: 'Not enough stock available.'
    }).then(() => {
      quantityInput.value = currentQuantity; // restore visual
    });
    return;
  }
  
    //  Send to backend
    $.ajax({
      url: '/changeQuantity',
      method: 'POST',
      data: { productId, count, size, color },
      success: (response) => {
        if (response.status) {
          const newQuantity = response.newQuantity;
          quantityInput.value = newQuantity;
  
          if (subtotalElement) {
            subtotalElement.innerText = (newQuantity * productPrice).toFixed(2);
          }
          if (totalElement) {
            totalElement.innerText = response.grandTotal.toFixed(2);
          }
          if (shippingChargeElement) {
            shippingChargeElement.innerText = response.shippingCharge.toFixed(2);
          }
          if (totalPayableElement) {
            totalPayableElement.innerText = response.totalPayable.toFixed(2);
          }
           // Update max stock in case it changed
        quantityInput.setAttribute('max', response.updatedStock);
         btnMinus.disabled = newQuantity <= 1;
          btnPlus.disabled = newQuantity >= Math.min(3, response.updatedStock);
        } else {
          Swal.fire('Error', response.error || 'Could not update quantity', 'error');
          btnMinus.disabled = false;
          btnPlus.disabled = false;
        }
      },  
      error: (err) => {
        console.error(err);
        Swal.fire('Error', 'Server error while updating quantity', 'error');
      }
    });
  }
  

  //Remove cart product
  function confirmRemove(productId, size, color, index) {
    Swal.fire({
      title: 'Are you sure?',
      text: 'Do you want to remove this item from your cart?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, remove it!'
    }).then((result) => {
      if (result.isConfirmed) {
        // Call your backend to remove the item
        $.ajax({
          url: '/removeCartItem',
          method: 'POST',
          data: { productId, size, color },
          success: (response) => {
            if(response.status){
              Swal.fire('Removed!', 'Your item has been removed.', 'success').then(() => {
                location.reload();
              });
            } else {
              Swal.fire('Error', response.message || 'Failed to remove item', 'error');
            }
          },
          error: () => {
            Swal.fire('Error', 'Server error while removing item', 'error');
          }
        });
      }
    });
  }
  </script>




