<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout with Bootstrap</title>
  <!-- Bootstrap CSS CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .address-card {
      cursor: pointer;
      border: 2px solid #ddd;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      transition: border-color 0.3s ease, background-color 0.3s ease;
      display: flex;
      align-items: center;
      gap: 20px;
      position: relative;
    }
    .address-card:hover {
      border-color: #0d6efd;
      background-color: #e7f1ff;
    }
    .address-card.selected {
      border-color: #0d6efd;
      background-color: #d0e2ff;
    }
    .address-type {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 9999px;
      font-weight: 700;
      font-size: 0.85rem;
      color: white;
      background-color: #0d6efd;
      margin-right: 15px;
      white-space: nowrap;
    }
    .address-type.office {
      background-color: #fd7e14;
    }
    .address-name {
      font-weight: 700;
      font-size: 1.15rem;
    }
    .address-text {
      margin-top: 6px;
      font-size: 1rem;
      color: #444;
      line-height: 1.5;
    }
    .address-actions {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      gap: 10px;
    }
    .address-actions button {
      border: none;
      background: transparent;
      color: #0d6efd;
      font-weight: 600;
      cursor: pointer;
      padding: 0;
    }
    .address-actions button:hover {
      text-decoration: underline;
    }
    /* For the radio */
    .form-check-input {
      cursor: pointer;
      width: 22px;
      height: 22px;
      flex-shrink: 0;
      margin: 0;
    }
    /* Order summary styling */
    .order-item {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 18px;
    }
    .order-item-icon {
      background: #e0e7ff;
      color: #4338ca;
      border-radius: 10px;
      width: 42px;
      height: 42px;
      display: grid;
      place-items: center;
      font-size: 22px;
    }
    .order-item-name {
      font-weight: 600;
      font-size: 1rem;
    }
    .order-item-qty {
      font-size: 0.85rem;
      color: #666;
    }
    .order-item-price {
      font-weight: 700;
      font-size: 1rem;
      margin-left: auto;
    }
    .order-summary-line {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      margin: 8px 0;
      font-size: 1rem;
    }
    .order-summary-line.total {
      font-size: 1.25rem;
      border-top: 1px solid #ddd;
      padding-top: 10px;
      margin-top: 16px;
    }
    .coupon-section input {
      flex-grow: 1;
      border-radius: 0.375rem;
      border: 1.5px solid #ced4da;
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
    }
    .coupon-section button {
      border-radius: 0.375rem;
      background: #0d6efd;
      border: none;
      color: white;
      font-weight: 700;
      padding: 0.5rem 1.5rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .coupon-section button:hover {
      background: #0b5ed7;
    }
    .payment-method label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      cursor: pointer;
    }
    .btn-place-order {
      background: #0d6efd;
      color: white;
      border: none;
      padding: 15px;
      font-size: 1.15rem;
      font-weight: 700;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      margin-top: 25px;
      transition: background-color 0.3s ease;
    }
    .btn-place-order:hover {
      background: #0b5ed7;
    }
  </style>
</head>
<body>

<div class="container my-5">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item"><a href="/cart">Cart</a></li>
      <li class="breadcrumb-item active" aria-current="page">Checkout</li>
    </ol>
  </nav>

  <div class="row g-4">
    <!-- Left: Shipping Addresses -->
    <div class="col-lg-7">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Shipping Address</h2>
        <a href="/addAddress" class="text-primary fw-semibold text-decoration-none">Add New Address</a>
      </div>

      <form id="checkoutForm">
        <div role="list" aria-label="Shipping addresses">
          <% if(userAddress && userAddress.address && userAddress.address.length > 0) { %>
            <% userAddress.address.forEach((addr, idx) => { %>
              <div
                class="address-card <%= idx === 0 ? 'selected' : '' %>"
                role="listitem"
                aria-checked="<%= idx === 0 ? 'true' : 'false' %>"
                tabindex="0"
                onclick="selectAddress(this)"
              >
                <input 
                  class="form-check-input" 
                  type="radio" 
                  id="addr<%= idx %>" 
                  name="shippingAddress" 
                  value="<%= addr._id %>" 
                  <%= idx === 0 ? 'checked' : '' %>
                />
                <div>
                  <span class="address-type <%= addr.addressType.toLowerCase() === 'office' ? 'office' : '' %>"><%= addr.addressType %></span>
                  <span class="address-name"><%= addr.name %></span>
                  <p class="address-text mb-0">
                    <%= addr.houseNo %><br />
                    <%= addr.city %>, <%= addr.state %><br />
                    Pincode: <%= addr.pincode %><br />
                    Phone: <%= addr.phone %><br />
                    <% if(addr.altPhone) { %>Alternate Phone: <%= addr.altPhone %><br /><% } %>
                  </p>
                </div>
                <div class="address-actions">
                  <a href="/editAddress?id=<%= addr._id %>" class="btn btn-sm btn-link p-0 me-2" aria-label="Edit address">Edit</a>
                  <a href="/deleteAddress?id=<%= addr._id %>" class="btn btn-sm btn-link p-0 text-danger" aria-label="Delete address" onclick="return confirm('Are you sure you want to delete this address?')">Delete</a>
                </div>
              </div>
            <% }); %>
          <% } else { %>
            <p>No addresses found. <a href="/addAddress">Add one now.</a></p>
          <% } %>
        </div>

        <!-- Payment method -->
        <div class="payment-method mt-4">
          <h3 class="fw-semibold mb-3">Payment Method</h3>
          <label class="d-flex align-items-center gap-2 mb-3" for="online">
            <input type="radio" id="online" name="paymentMethod" value="online" />
            <span>Online Payment </span>
          </label>
          <label class="d-flex align-items-center gap-2" for="cod">
            <input type="radio" id="cod" name="paymentMethod" value="cod" checked />
            <span>Cash on Delivery</span>
          </label>
        </div>

        <button type="submit" id="placeOrderBtn" class="btn-place-order">Place Order</button>
      </form>
    </div>

    <!-- Right: Order Summary -->
    <div class="col-lg-5 bg-white p-4 rounded shadow-sm">
      <h2>Your Order</h2>

      <% if(cartItems && cartItems.length > 0) { %>
        <% cartItems.forEach(item => { %>
          <div class="order-item" role="listitem">
            <div class="order-item-icon" aria-hidden="true">
              <img src="/<%= item.productId.images[0] %>" alt="<%= item.productId.name%>" style="width:32px; height:32px; border-radius:4px;">
            </div>
            <div>
              <div class="order-item-name"><%= item.productId.name.split('|')[0].trim() %></div>
              <div class="order-item-qty">x <%= item.quantity %></div>
              <div class="order-item-size-color small text-muted">Size: <%= item.size %>, Color: <%= item.color %></div>
            </div>
            <div class="order-item-price">₹ <%= (item.productId.finalPrice * item.quantity).toFixed(2) %></div>
          </div>
        <% }); %>
      <% } else { %>
        <p>Your cart is empty.</p>
      <% } %>

      <div class="order-summary-line d-flex justify-content-between fw-semibold mt-3">
        <span>Subtotal</span>
        <span>₹ <%= grandTotal %></span>
      </div>
      <!-- You can add discount or coupon here if needed -->
      <div class="order-summary-line d-flex justify-content-between mt-2">
        <span>Shipping</span>
        <span><%= shippingCharge %></span>
      </div>
      <div class="order-summary-line total d-flex justify-content-between fw-bold mt-2 border-top pt-2">
        <span>Total</span>
        <span>₹ <%= parseFloat(totalPayable).toFixed(2) %></span>
      </div>
    </div>
  </div>
</div>

<script>
  function selectAddress(card) {
    document.querySelectorAll('.address-card').forEach(c => {
      c.classList.remove('selected');
      c.setAttribute('aria-checked', 'false');
      c.querySelector('input[type="radio"]').checked = false;
    });
    card.classList.add('selected');
    card.setAttribute('aria-checked', 'true');
    card.querySelector('input[type="radio"]').checked = true;
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.getElementById('placeOrderBtn').addEventListener('click', async () => {
    // Get selected address ID
    const selectedAddress = document.querySelector('input[name="shippingAddress"]:checked');
    if (!selectedAddress) {
      await Swal.fire({
        icon: 'warning',
        title: 'Oops!',
        text: 'Please select a shipping address.'
      });
      return;
    }

    // Get selected payment method
    const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
    if (!selectedPayment) {
      await Swal.fire({
        icon: 'warning',
        title: 'Oops!',
        text: 'Please select a payment method.'
      });
      return;
    }

    const data = {
      shippingAddress: selectedAddress.value,
      paymentMethod: selectedPayment.value
    };

    try {
      const response = await fetch('/placeOrder', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (response.ok && result.status) {
        // Redirect to order success page with orderId
        window.location.href = `/order-success/${result.orderId}`;
      } else {
        await Swal.fire({
          icon: 'error',
          title: 'Order Failed',
          text: result.message || 'Failed to place order.'
        });
      }
    } catch (error) {
      console.error('Error placing order:', error);
      await Swal.fire({
        icon: 'error',
        title: 'Server Error',
        text: 'Server error while placing order.'
      });
    }
  });
</script>


<!-- Bootstrap JS Bundle CDN -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
