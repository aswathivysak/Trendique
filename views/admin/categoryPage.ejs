<!-- PAGE HEADER -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Category Management</h3>
    <div class="d-flex">
      <form method="GET" action="/admin/category" class="me-3">
        <input 
          type="text" 
          name="search" 
          placeholder="Search category..." 
          value="<%= searchQuery || '' %>" 
          class="form-control" 
          style="width: 250px;" 
        />
      </form>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
        + Add Category
      </button>
    </div>
  </div>
  
  <!-- CATEGORY TABLE -->
  <div class="card shadow-sm rounded">
    <div class="card-body p-0">
      <table class="table table-hover mb-0">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Category Name</th>
            <th>Image</th>
            <th>Description</th>
            <th>Status</th>
            <th>Offer %</th>
            <th>Valid Until</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (cat.length === 0) { %>
            <tr><td colspan="8" class="text-center py-4">No categories found</td></tr>
          <% } else { %>
            <% cat.forEach((category, index) => { %>
              <tr>
                <td><%= (currentPage - 1) * limit + index + 1 %></td>
                <td><%= category.name %></td>
                <td>
                  <img 
                    src="/uploads/categories/<%= category.categoryImage %>" 
                    alt="<%= category.name %>" 
                    style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; cursor: pointer;"
                    onclick="openImageModal('/uploads/categories/<%= category.categoryImage %>')"
                  />
                </td>
                <td><%= category.description.length > 60 ? category.description.substring(0, 57) + '...' : category.description %></td>
                <td>
                  <% if (category.isListed) { %>
                    <span class="badge bg-success">Listed</span>
                  <% } else { %>
                    <span class="badge bg-danger">Unlisted</span>
                  <% } %>
                </td>
                <td><%= category.categoryOffer ? category.categoryOffer + '%' : '-' %></td>
                <td><%= category.offerValidUntil ? new Date(category.offerValidUntil).toLocaleDateString('en-GB') : '-' %></td>
                <td>
                  <button class="btn btn-sm btn-info me-1" title="Edit" onclick="populateEditModal('<%= category._id %>', '<%= category.name %>', '<%= category.description %>', '<%= category.categoryImage %>')"
                          data-bs-toggle="modal" data-bs-target="#editCategoryModal">
                    <i class="fas fa-edit"></i>
                  </button>
  
                  <button class="btn btn-sm btn-danger me-1" title="Delete" onclick="deleteCategory('<%= category._id %>')">
                    <i class="fas fa-trash-alt"></i>
                  </button>
  
                  <% if (!category.categoryOffer || category.categoryOffer === 0) { %>
                    <button class="btn btn-sm btn-primary me-1" title="Add Offer" onclick="addOffer('<%= category._id %>')">Offer</button>
                  <% } else { %>
                    <button class="btn btn-sm btn-warning me-1" title="Remove Offer" onclick="deleteOffer('<%= category._id %>')">Remove Offer</button>
                  <% } %>
  
                  <% if (category.isListed) { %>
                    <button class="btn btn-sm btn-secondary me-1" title="Unlist" onclick="unlistCategory('<%= category._id %>')">Unlist</button>
                  <% } else { %>
                    <button class="btn btn-sm btn-success me-1" title="List" onclick="listCategory('<%= category._id %>')">List</button>
                  <% } %>
  
                  <button class="btn btn-sm btn-dark" title="Subcategories" onclick="window.location.href='/admin/subcategories?categoryId=<%= category._id %>'">
                    <i class="fas fa-layer-group"></i>
                  </button>
                </td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- PAGINATION -->
  <nav class="mt-3 d-flex justify-content-center">
    <ul class="pagination pagination-sm">
      <% if (currentPage > 1) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage - 1 %><%= searchQuery ? '&search=' + searchQuery : '' %>">Previous</a>
        </li>
      <% } %>
      <% for(let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
          <a class="page-link" href="?page=<%= i %><%= searchQuery ? '&search=' + searchQuery : '' %>"><%= i %></a>
        </li>
      <% } %>
      <% if (currentPage < totalPages) { %>
        <li class="page-item">
          <a class="page-link" href="?page=<%= currentPage + 1 %><%= searchQuery ? '&search=' + searchQuery : '' %>">Next</a>
        </li>
      <% } %>
    </ul>
  </nav>
  
  <!-- ADD CATEGORY MODAL -->
  <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form id="addCategoryForm" class="modal-content" enctype="multipart/form-data" method="POST" action="/admin/addCategory">
        <div class="modal-header">
          <h5 class="modal-title" id="addCategoryModalLabel">Add New Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          
          <div class="mb-3">
            <label for="categoryName" class="form-label">Category Name</label>
            <input type="text" name="name" class="form-control" id="categoryName" required>
          </div>
  
          <div class="mb-3">
            <label for="categoryDescription" class="form-label">Description</label>
            <textarea name="description" class="form-control" id="categoryDescription" rows="3" required></textarea>
          </div>
  
          <div class="mb-3">
            <label for="categoryGender" class="form-label">Gender</label>
            <select name="gender" id="categoryGender" class="form-select" required>
              <option value="Women" selected>Women</option>
            </select>
          </div>
  
          <div class="mb-3">
            <label for="categoryImage" class="form-label">Product Gallery</label>
            <input type="file" name="categoryImage" id="categoryImage" class="form-control" accept="image/png, image/jpeg" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Category</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- EDIT CATEGORY MODAL -->
  <div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <form id="editCategoryForm" class="modal-content" enctype="multipart/form-data" method="POST">
        <input type="hidden" id="edit-category-id" name="categoryId" />
        <div class="modal-header">
          <h5 class="modal-title" id="editCategoryModalLabel">Edit Category</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          
          <div class="mb-3">
            <label for="edit-category-name" class="form-label">Category Name</label>
            <input type="text" name="name" class="form-control" id="edit-category-name" required>
          </div>
  
          <div class="mb-3">
            <label for="edit-category-description" class="form-label">Description</label>
            <textarea name="description" class="form-control" id="edit-category-description" rows="3" required></textarea>
          </div>
  
          <div class="mb-3">
            <label for="edit-category-image" class="form-label">Current Image</label><br/>
            <img id="existing-category-image" src="" alt="Category Image" style="width: 100px; height: 100px; object-fit: cover; border-radius: 6px;">
          </div>
  
          <div class="mb-3">
            <label for="edit-category-image-upload" class="form-label">Change Image (optional)</label>
            <input type="file" name="categoryImage" id="edit-category-image-upload" class="form-control" accept="image/png, image/jpeg">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Category</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- IMAGE PREVIEW MODAL -->
  <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content p-3">
        <img id="modalImage" src="" alt="Category Image" class="img-fluid rounded" />
        <button type="button" class="btn btn-secondary mt-3" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
  
  <!-- JS (use Bootstrap 5 + FontAwesome for icons) -->
  <script>
    function openImageModal(src) {
      document.getElementById('modalImage').src = src;
      const modal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
      modal.show();
    }
  
    function populateEditModal(id, name, description, image) {
      document.getElementById('edit-category-id').value = id;
      document.getElementById('edit-category-name').value = name;
      document.getElementById('edit-category-description').value = description;
      document.getElementById('existing-category-image').src = `/uploads/categories/${image}`;
      document.getElementById('editCategoryForm').action = `/admin/editCategory/${id}`;
    }
  
    function deleteCategory(id) {
      if (confirm("Are you sure you want to delete this category?")) {
        fetch(`/admin/deleteCategory/${id}`, { method: 'DELETE' })
          .then(res => res.json())
          .then(data => {
            if (data.success) location.reload();
            else alert(data.message || 'Failed to delete category');
          })
          .catch(() => alert('Server error'));
      }
    }
  
    // Add your existing addOffer, deleteOffer, listCategory, unlistCategory JS here
  </script>
  